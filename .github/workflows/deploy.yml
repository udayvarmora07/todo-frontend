name: Build and Deploy Frontend

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., 1.0.0)'
        required: false
        default: ''

# Prevent concurrent builds on the same ref
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  id-token: write
  contents: write
  packages: write
  security-events: write

env:
  GHCR_CACHE: ghcr.io/${{ github.repository }}:buildcache
  NODE_VERSION: '22.17.0'

jobs:
  build-and-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    timeout-minutes: 30

    outputs:
      image_tag: ${{ steps.meta.outputs.BUILD_VERSION }}
      ecr_image: ${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY }}:${{ steps.meta.outputs.BUILD_VERSION }}
      ghcr_image: ghcr.io/${{ github.repository }}:${{ steps.meta.outputs.BUILD_VERSION }}

    steps:
      # =========================================================================
      # Checkout & Metadata
      # =========================================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate build metadata
        id: meta
        run: |
          # Determine version from release, input, or SHA
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          elif [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_SHA::7}"
          fi
          
          # Remove 'v' prefix if present
          BUILD_VERSION="${VERSION#v}"
          
          # Validate semver format (loose check)
          if [[ ! "$BUILD_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+ ]] && [[ ! "$BUILD_VERSION" =~ ^[a-f0-9]{7}$ ]]; then
            echo "âš ï¸ Warning: Version '$BUILD_VERSION' is not semver format"
          fi
          
          echo "BUILD_VERSION=${BUILD_VERSION}" >> $GITHUB_OUTPUT
          echo "BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
          echo "GIT_SHA=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          
          echo "ðŸ“‹ Build Version: $BUILD_VERSION"
          echo "ðŸ“‹ Git SHA: ${GITHUB_SHA::7}"

      - name: Validate build version
        run: |
          if [ -z "${{ steps.meta.outputs.BUILD_VERSION }}" ]; then
            echo "âŒ ERROR: BUILD_VERSION is empty!"
            exit 1
          fi
          echo "âœ… BUILD_VERSION: ${{ steps.meta.outputs.BUILD_VERSION }}"

      # =========================================================================
      # AWS & Registry Authentication
      # =========================================================================
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: github-actions-${{ github.run_id }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # =========================================================================
      # Docker Build Setup
      # =========================================================================
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract Docker metadata
        id: docker-meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY }}
            ghcr.io/${{ github.repository }}
          tags: |
            type=raw,value=${{ steps.meta.outputs.BUILD_VERSION }}
            type=raw,value=latest
            type=sha,prefix=sha-,format=short
          labels: |
            org.opencontainers.image.title=Todo Frontend
            org.opencontainers.image.version=${{ steps.meta.outputs.BUILD_VERSION }}
            org.opencontainers.image.created=${{ steps.meta.outputs.BUILD_DATE }}
            org.opencontainers.image.revision=${{ github.sha }}

      # =========================================================================
      # Build & Push Docker Image
      # =========================================================================
      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.docker-meta.outputs.tags }}
          labels: ${{ steps.docker-meta.outputs.labels }}
          build-args: |
            NODE_VERSION=${{ env.NODE_VERSION }}
          cache-from: |
            type=registry,ref=${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY }}:buildcache
            type=registry,ref=${{ env.GHCR_CACHE }}
          cache-to: |
            type=registry,ref=${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY }}:buildcache,mode=max
            type=registry,ref=${{ env.GHCR_CACHE }},mode=max
          provenance: false
          sbom: false

      # =========================================================================
      # Security Scanning
      # =========================================================================
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/${{ github.repository }}:${{ steps.meta.outputs.BUILD_VERSION }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      # =========================================================================
      # Post-Build Steps
      # =========================================================================
      - name: Update release with image details
        if: github.event_name == 'release'
        uses: actions/github-script@v7
        with:
          script: |
            const release = context.payload.release;
            const ecrImage = "${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY }}:${{ steps.meta.outputs.BUILD_VERSION }}";
            const ghcrImage = "ghcr.io/${{ github.repository }}:${{ steps.meta.outputs.BUILD_VERSION }}";
            const digest = "${{ steps.build.outputs.digest }}";
            
            const imageDetails = `

            ---

            ## ðŸ³ Docker Images

            | Registry | Image | Digest |
            |----------|-------|--------|
            | **ECR** | \`${ecrImage}\` | \`${digest.slice(0, 20)}...\` |
            | **GHCR** | \`${ghcrImage}\` | \`${digest.slice(0, 20)}...\` |

            ### Pull Commands
            \`\`\`bash
            # From ECR (AWS)
            docker pull ${ecrImage}

            # From GHCR (Public)
            docker pull ${ghcrImage}
            \`\`\`

            ### Runtime Configuration
            Set these environment variables in App Runner:
            - \`VITE_API_URL\` - Backend API URL (required)

            ### Security
            - âœ… Vulnerability scan completed
            - ðŸ“‹ Results available in Security tab
            `;
            
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.id,
              body: (release.body || '') + imageDetails
            });

      - name: Generate build summary
        run: |
          echo "## ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | \`${{ steps.meta.outputs.BUILD_VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ steps.meta.outputs.GIT_SHA }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Build Date** | ${{ steps.meta.outputs.BUILD_DATE }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Node Version** | ${{ env.NODE_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Digest** | \`${{ steps.build.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Docker Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ECR**: \`${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY }}:${{ steps.meta.outputs.BUILD_VERSION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **GHCR**: \`ghcr.io/${{ github.repository }}:${{ steps.meta.outputs.BUILD_VERSION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”’ Security" >> $GITHUB_STEP_SUMMARY
          echo "- Trivy vulnerability scan completed" >> $GITHUB_STEP_SUMMARY
          echo "- Results uploaded to Security tab" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Cache" >> $GITHUB_STEP_SUMMARY
          echo "- ECR: \`${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY }}:buildcache\`" >> $GITHUB_STEP_SUMMARY
          echo "- GHCR: \`${{ env.GHCR_CACHE }}\`" >> $GITHUB_STEP_SUMMARY

name: Build and Deploy Frontend

on:
  release:
    types: [published]

permissions:
  id-token: write
  contents: write
  packages: write

env:
  # Cache image tags - used for layer caching in both registries
  GHCR_CACHE: ghcr.io/${{ github.repository }}:buildcache
  # ECR cache will be set after login

jobs:
  build-and-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    timeout-minutes: 30

    outputs:
      image_tag: ${{ steps.meta.outputs.BUILD_VERSION }}
      ecr_image: ${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY }}:${{ steps.meta.outputs.BUILD_VERSION }}

    steps:
      # =========================================================================
      # Checkout & Metadata
      # =========================================================================
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate image tags and metadata
        id: meta
        run: |
          # Get release tag or fallback to short SHA
          if [ "${{ github.event_name }}" == "release" ]; then
            RELEASE_TAG="${{ github.event.release.tag_name }}"
          else
            RELEASE_TAG="${GITHUB_SHA::7}"
          fi
          
          if [ -z "$RELEASE_TAG" ]; then
            RELEASE_TAG="${GITHUB_SHA::7}"
            echo "âš ï¸ No release tag found, using short SHA: $RELEASE_TAG"
          fi
          
          # Remove 'v' prefix if present
          BUILD_VERSION="${RELEASE_TAG#v}"
          
          echo "BUILD_VERSION=${BUILD_VERSION}" >> $GITHUB_OUTPUT
          echo "RELEASE_TAG=${RELEASE_TAG}" >> $GITHUB_OUTPUT
          echo "BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
          
          echo "ðŸ“‹ Release Tag: $RELEASE_TAG"
          echo "ðŸ“‹ Build Version: $BUILD_VERSION"

      - name: Validate build version
        run: |
          if [ -z "${{ steps.meta.outputs.BUILD_VERSION }}" ]; then
            echo "âŒ ERROR: BUILD_VERSION is empty!"
            exit 1
          fi
          echo "âœ… BUILD_VERSION: ${{ steps.meta.outputs.BUILD_VERSION }}"

      # =========================================================================
      # AWS & Registry Authentication
      # =========================================================================
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: github-actions-${{ github.run_id }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # =========================================================================
      # Docker Build Setup
      # =========================================================================
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract Docker metadata
        id: docker-meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY }}
            ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}
          tags: |
            type=raw,value=${{ steps.meta.outputs.BUILD_VERSION }}
            type=raw,value=latest
            type=sha,prefix=sha-,format=short

      # =========================================================================
      # Build & Push Docker Image with Dual Registry Caching
      # =========================================================================
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.docker-meta.outputs.tags }}
          labels: ${{ steps.docker-meta.outputs.labels }}
          # Dual registry caching - try ECR first (faster in AWS), fallback to GHCR
          cache-from: |
            type=registry,ref=${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY }}:buildcache
            type=registry,ref=${{ env.GHCR_CACHE }}
          cache-to: |
            type=registry,ref=${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY }}:buildcache,mode=max
            type=registry,ref=${{ env.GHCR_CACHE }},mode=max
          provenance: false
          sbom: false

      # =========================================================================
      # Post-Build Steps
      # =========================================================================
      - name: Update release with image details
        if: github.event_name == 'release'
        uses: actions/github-script@v7
        with:
          script: |
            const release = context.payload.release;
            const ecrImage = "${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY }}:${{ steps.meta.outputs.BUILD_VERSION }}";
            const ghcrImage = "ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ steps.meta.outputs.BUILD_VERSION }}";
            
            const imageDetails = `

            ---

            ## ðŸ³ Docker Images

            | Registry | Image |
            |----------|-------|
            | **ECR** | \`${ecrImage}\` |
            | **GHCR** | \`${ghcrImage}\` |

            ### Pull Commands
            \`\`\`bash
            # From ECR
            docker pull ${ecrImage}

            # From GHCR
            docker pull ${ghcrImage}
            \`\`\`

            ### Runtime Configuration
            Set these environment variables in App Runner:
            - \`VITE_API_URL\` - Backend API URL
            `;
            
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.id,
              body: (release.body || '') + imageDetails
            });

      - name: Generate build summary
        run: |
          echo "## ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | \`${{ steps.meta.outputs.BUILD_VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${GITHUB_SHA::7}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Build Date** | ${{ steps.meta.outputs.BUILD_DATE }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Cache (ECR)** | \`${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY }}:buildcache\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Cache (GHCR)** | \`${{ env.GHCR_CACHE }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Docker Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ECR**: \`${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY }}:${{ steps.meta.outputs.BUILD_VERSION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **GHCR**: \`ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ steps.meta.outputs.BUILD_VERSION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note**: This image builds at container startup. Set \`VITE_API_URL\` in App Runner environment." >> $GITHUB_STEP_SUMMARY
